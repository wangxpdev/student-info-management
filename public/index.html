<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç”Ÿç®¡ç†ç³»ç»Ÿ v1.1</title>
  <link rel="icon"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='0' y='0' width='64' height='64' rx='16' fill='%232563eb'/%3E%3Cpath fill='%23ffffff' d='M32 12L2 26l30 14 30-14zM8 30v12c0 4.4 5.4 8 12 8s12-3.6 12-8V30l-12 5.6zM56 28v14h4V26z'/%3E%3C/svg%3E">
  <style>
    :root {
      --primary: #2563eb;
      --bg: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --border: #e2e8f0;
      --accent: #3b82f6;
    }

    body {
      font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding: 40px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 20px;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      color: var(--primary);
      font-weight: 800;
    }

    .card {
      background: var(--surface);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    /* --- æ–°å¢ï¼šä»ªè¡¨ç›˜æ ·å¼ --- */
    .dashboard {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      flex: 1;
      background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--primary);
      margin: 10px 0;
    }

    .stat-label {
      font-size: 14px;
      color: #64748b;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* ----------------------- */

    .form-row {
      display: flex;
      gap: 15px;
      align-items: flex-end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    label {
      font-size: 12px;
      margin-bottom: 6px;
      font-weight: 700;
      color: #64748b;
    }

    input {
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      outline: none;
      transition: all 0.2s;
      font-size: 14px;
    }

    input:focus {
      border-color: var(--primary);
      background: #fff;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      transition: all 0.2s;
      font-size: 14px;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .btn-success {
      background: #10b981;
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      font-size: 12px;
    }

    .btn-edit {
      background: #f59e0b;
      color: white;
      padding: 6px 12px;
      font-size: 12px;
      margin-right: 8px;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--border);
      color: #64748b;
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .search-box {
      flex: 1;
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      outline: none;
    }

    .search-box:focus {
      border-color: var(--primary);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th {
      text-align: left;
      padding: 16px;
      border-bottom: 2px solid var(--border);
      color: #475569;
      font-size: 14px;
      font-weight: 700;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tr:hover td {
      background-color: #f8fafc;
    }

    .hidden {
      display: none;
    }

    .score-pass {
      color: #10b981;
      font-weight: 700;
      background: #ecfdf5;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .score-fail {
      color: #ef4444;
      font-weight: 700;
      background: #fef2f2;
      padding: 4px 8px;
      border-radius: 4px;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>å­¦ç”Ÿä¿¡æ¯ç®¡ç†ç³»ç»Ÿ</h1>
        <span style="font-size: 13px; color: #94a3b8; font-weight: 500;">Java Native Project v1.1</span>
      </div>
    </header>

    <div class="dashboard">
      <div class="stat-card">
        <div class="stat-label">æ€»äººæ•°</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å¹³å‡åˆ†</div>
        <div class="stat-value" id="statAvg">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">åŠæ ¼ç‡</div>
        <div class="stat-value" id="statPass">0%</div>
      </div>
    </div>

    <div class="card">
      <div class="form-row">
        <div class="input-group">
          <label>å­¦å· (ID)</label>
          <input type="number" id="sid" placeholder="ä¾‹å¦‚: 1001">
        </div>
        <div class="input-group">
          <label>å§“å (Name)</label>
          <input type="text" id="sname" placeholder="ä¾‹å¦‚: å¼ ä¸‰">
        </div>
        <div class="input-group">
          <label>æˆç»© (Score)</label>
          <input type="number" id="sscore" placeholder="0-100">
        </div>
        <button id="addBtn" class="btn-primary" onclick="addStudent()">+ å½•å…¥å­¦ç”Ÿ</button>
        <button id="updateBtn" class="btn-success hidden" onclick="updateStudent()">âœ“ ä¿å­˜ä¿®æ”¹</button>
        <button id="cancelBtn" class="btn-outline hidden" onclick="cancelEdit()">å–æ¶ˆ</button>
      </div>
    </div>

    <div class="controls">
      <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” æœç´¢å§“åæˆ–å­¦å·..." oninput="searchStudents()">
      <button class="btn-outline" onclick="loadStudents('id')">æ’åº: å­¦å·</button>
      <button class="btn-outline" onclick="loadStudents('score')">æ’åº: æˆç»©</button>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
      <table id="stuTable">
        <thead>
          <tr>
            <th>å­¦å·</th>
            <th>å§“å</th>
            <th>æˆç»©</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentSort = 'id';
    let currentSearch = '';

    // 1. åŠ è½½ä¸æ¸²æŸ“
    async function loadStudents(sortType) {
      if (sortType) currentSort = sortType;

      let url = `/api/students?sort=${currentSort}`;
      if (currentSearch) url += `&q=${encodeURIComponent(currentSearch)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        render(data);
        calculateStats(data); // æ¸²æŸ“æ—¶é¡ºä¾¿è®¡ç®—ç»Ÿè®¡æ•°æ®
      } catch (e) {
        console.error("åŠ è½½å¤±è´¥:", e);
      }
    }

    // æ–°å¢ï¼šå‰ç«¯ç»Ÿè®¡é€»è¾‘
    function calculateStats(data) {
      const total = data.length;
      document.getElementById('statTotal').innerText = total;

      if (total === 0) {
        document.getElementById('statAvg').innerText = '0';
        document.getElementById('statPass').innerText = '0%';
        return;
      }

      // è®¡ç®—å¹³å‡åˆ†
      const sum = data.reduce((acc, curr) => acc + curr.score, 0);
      const avg = (sum / total).toFixed(1); // ä¿ç•™ä¸€ä½å°æ•°
      document.getElementById('statAvg').innerText = avg;

      // è®¡ç®—åŠæ ¼ç‡
      const passCount = data.filter(s => s.score >= 60).length;
      const passRate = Math.round((passCount / total) * 100);
      document.getElementById('statPass').innerText = passRate + '%';

      // æ ¹æ®åŠæ ¼ç‡å˜è‰² (å¯é€‰ä¼˜åŒ–)
      const passEl = document.getElementById('statPass');
      passEl.style.color = passRate >= 60 ? '#10b981' : '#ef4444';
    }

    function render(data) {
      const tbody = document.querySelector('#stuTable tbody');
      tbody.innerHTML = '';
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8; padding: 30px;">æš‚æ— æ•°æ®ï¼Œè¯·æ·»åŠ å­¦ç”Ÿ</td></tr>';
        return;
      }
      data.forEach(s => {
        const tr = document.createElement('tr');
        const scoreClass = s.score < 60 ? 'score-fail' : 'score-pass';

        tr.innerHTML = `
                    <td><b style="color:#64748b">#${s.id}</b></td>
                    <td><b>${s.name}</b></td>
                    <td><span class="${scoreClass}">${s.score}</span></td>
                    <td>
                        <button class="btn-edit" onclick="startEdit(${s.id}, '${s.name}', ${s.score})">ç¼–è¾‘</button>
                        <button class="btn-danger" onclick="delStudent(${s.id})">åˆ é™¤</button>
                    </td>
                `;
        tbody.appendChild(tr);
      });
    }

    // 2. æ·»åŠ å­¦ç”Ÿ
    async function addStudent() {
      const id = document.getElementById('sid').value;
      const name = document.getElementById('sname').value;
      const score = document.getElementById('sscore').value;

      if (!id || !name || !score) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');

      const url = `/api/add?id=${id}&name=${encodeURIComponent(name)}&score=${score}`;
      const res = await fetch(url);
      const result = await res.json();

      if (result.status === 'error') {
        alert(result.message === 'ID exists' ? 'è¯¥å­¦å·å·²å­˜åœ¨ï¼' : 'æ·»åŠ å¤±è´¥');
      } else {
        clearForm();
        loadStudents();
      }
    }

    // 3. åˆ é™¤å­¦ç”Ÿ
    async function delStudent(id) {
      if (confirm('ç¡®å®šåˆ é™¤å­¦å· ' + id + ' å—ï¼Ÿ')) {
        await fetch(`/api/delete?id=${id}`);
        loadStudents();
      }
    }

    // 4. ç¼–è¾‘æ¨¡å¼
    function startEdit(id, name, score) {
      document.getElementById('sid').value = id;
      document.getElementById('sid').disabled = true;
      document.getElementById('sname').value = name;
      document.getElementById('sscore').value = score;

      document.getElementById('addBtn').classList.add('hidden');
      document.getElementById('updateBtn').classList.remove('hidden');
      document.getElementById('cancelBtn').classList.remove('hidden');
    }

    async function updateStudent() {
      const id = document.getElementById('sid').value;
      const name = document.getElementById('sname').value;
      const score = document.getElementById('sscore').value;

      await fetch(`/api/update?id=${id}&name=${encodeURIComponent(name)}&score=${score}`);
      cancelEdit();
      loadStudents();
    }

    function cancelEdit() {
      clearForm();
      document.getElementById('sid').disabled = false;
      document.getElementById('addBtn').classList.remove('hidden');
      document.getElementById('updateBtn').classList.add('hidden');
      document.getElementById('cancelBtn').classList.add('hidden');
    }

    function clearForm() {
      document.getElementById('sid').value = '';
      document.getElementById('sname').value = '';
      document.getElementById('sscore').value = '';
    }

    function searchStudents() {
      currentSearch = document.getElementById('searchBox').value;
      loadStudents();
    }

    // åˆå§‹åŒ–
    loadStudents();
  </script>
</body>

</html>